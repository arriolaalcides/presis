{% extends '::base.html.twig' %}
{% block contenido %}
    <form id="form">
        <div id="to_tab">
            <legend>Cambio de estado</legend>
            <div class="row">
                <div class="form-group">
                    <label class="control-label col-lg-1" for="tracking">Tracking</label>
                    <div class="col-lg-2">
                        <input type="text" id="tracking" name="tracking" required="required" maxlength="100" class="form-control input-sm" autofocus>
                    </div>
                    <label class="control-label col-lg-1" for="remito">Remito</label>
                    <div class="col-lg-2">
                        <input type="text" id="remito" name="remito" maxlength="100" class="form-control">
                    </div>
                    <label class="control-label col-lg-2" for="guiaagente">Guia agente</label>
                    <div class="col-lg-2">
                        <input type="text" id="guiaagente" name="guiaagente" maxlength="100" class="form-control">
                    </div>
                </div>
                <br /><br />
            </div>
            <div class="row form-group">
                {% if not distribuidor %}
                    {{ form_row(form.distribuidor,{'style': 'horizontal', 'label_col': 1, 'widget_col': 5, 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
                {% else %}
                    {{ form_row(form.distribuidor,{value: "" ~ distribuidor.id, 'style': 'horizontal', 'label_col': 1, 'widget_col': 5, 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
                {% endif %}
                <label class="control-label col-lg-1" for="createGuia">Usuario</label>
                <div class="col-lg-3">
                    <input type="text" id="createguia" name="createguia" class="form-control input-sm" disabled>
                </div>
            </div>
            <div class="row form-group">
                <label class="control-label col-lg-1" for="clientenombre">Cliente</label>
                <div class="col-lg-3">
                    <input type="text" id="clientenombre" name="clientenombre" class="form-control input-sm" disabled>
                </div>
                <label class="control-label col-lg-1" for="comprador_email">Email</label>
                <div class="col-lg-3">
                    <input type="text" id="comprador_email" name="comprador_email" class="form-control input-sm" disabled>
                </div>

                <br /><br />
                <label class="control-label col-lg-1" for="remitente">Remitente</label>
                <div class="col-lg-3">
                    <input type="text" id="remitente" name="remitente" class="form-control input-sm" disabled>
                </div>
                <label class="control-label col-lg-1" for="direccion_remitente">Direccion</label>
                <div class="col-lg-3">
                    <input type="text" id="direccion_remitente" name="direccion_remitente" class="form-control input-sm" disabled>
                </div>
                <label class="control-label col-lg-1" for="localidad_remitente">Localidad</label>
                <div class="col-lg-3">
                    <input type="text" id="localidad_remitente" name="localidad_remitente" class="form-control input-sm" disabled>
                </div>
                <br /><br />

                <label class="control-label col-lg-1" for="comprador">Destinatario</label>
                <div class="col-lg-3">
                    <input type="text" id="comprador" name="comprador" class="form-control input-sm" disabled>
                </div>
                <label class="control-label col-lg-1" for="direccion_destinatario">Direccion</label>
                <div class="col-lg-3">
                    <input type="text" id="direccion_destinatario" name="direccion_destinatario" class="form-control input-sm" disabled>
                </div>
                <label class="control-label col-lg-1" for="localidad_destinatario">Localidad</label>
                <div class="col-lg-3">
                    <input type="text" id="localidad_destinatario" name="localidad_destinatario" class="form-control input-sm" disabled>
                </div>
                <br /><br />
            </div>
        </div>
        <legend>Receptor</legend>
        <div class="row">
            <div class="form-group">
                {{ form_row(form.receptorNombre,{'label': 'Nombre', 'style': 'horizontal', 'label_col': 1, 'widget_col': 3, 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
                {{ form_row(form.receptorApellido,{'label': 'Apellido', 'style': 'horizontal', 'label_col': 1, 'widget_col': 3, 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
                {{ form_row(form.dni,{'style': 'horizontal', 'label_col': 1, 'widget_col': 3, 'id': 'dni', 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                {{ form_row(form.detalles,{'style': 'horizontal', 'label_col': 1, 'widget_col': 11, 'id': 'detalles', 'attr': {onkeypress:"return tabular(event,this)"}}) }}
            </div>
        </div>
        <div class="row">
            <div class="form-group">
                {{ form_row(form.receptorFechaHora,{'label': 'Fecha Recepción', 'style': 'horizontal', 'label_col': 2, 'widget_col': 2, 'id': 'fecha', 'attr': {class: 'input-sm datetimepicker6', onkeypress:"return tabular(event,this)"}}) }}
                {{ form_row(form.motivo,{'style': 'horizontal', 'label_col': 1, 'widget_col': 2, 'id': 'motivo', 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
                {{ form_row(form.estado,{'style': 'horizontal', 'label_col': 1, 'widget_col': 2, 'id': 'estado', 'attr': {class: 'input-sm', onkeypress:"return tabular(event,this)"}}) }}
            </div>
        </div>
        </div>
    </form>
    <div class="form-group row col-lg-4">
        <button id="agregar-estado" name="agregar-estado" class="btn btn-success btn-sm btn-primary">AGREGAR ESTADO</button>
        <button id="reclamos" name="reclamos" class="btn btn-success btn-sm btn-primary" disabled>AGREGAR RECLAMO</button>
    </div>

    <legend>Tracker</legend>
    <div class="row">
        <table id="table_tracker" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>Id</th>
                <th>Tracker</th>
                <th>Estado</th>
                <th>Planilla</th>
                <th>Fecha Planilla</th>
                <th>Distrib.</th>
                <th>Motivo</th>
                <th>Receptor</th>
                <th>DNI</th>
                <th>Fecha</th>
                <th>Agregado por</th>
                <th>Timestamp</th>
                <th>Detalle</th>
                <th>Acciones</th>
            </tr>
            </thead>
        </table>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript" src="{{ asset('js/readonly.js') }}"></script>

    <script>
        function deleteRow(id) {
            // Initialize your table
            var table = $('#table_tracker').dataTable();
            if(table.fnGetData().length==1){
                alert("Imposible eliminar registro.");
                return false;
            }else{
                $.blockUI({message:"<h3>Eliminando datos...</h3>"})
                $.ajax( {
                    url: Routing.generate('tracker_delete',{id:id} )
                }).done(function() {
                    $('#table_tracker').DataTable().ajax.reload();
                    $.unblockUI();
                });
            }
        }

        $(document).ready( function () {
            var tracking = $("#tracking");
            var remito = $("#remito");
            var guia_agente = $("#guiaagente");
            var hora;

            if ($("select[id*='tracker_distribuidor'] option:selected").val()) {
                readonly("select[id*='tracker_distribuidor']", true);
            }

            //Seleccionar lo escrito cuando el número de tracker reciba foco
            $("#to_tab input:text").focus(function() { $(this).select(); } );

            //Boton de reclamos abre nueva pestaña
            $( "#reclamos" ).click(function() {
                window.open(Routing.generate('reclamo_new', {retiro_id: tracking.val()}), '_blank');
            });


            $('#estado').change(function() {
                $("#agregar-estado").focus();
            });

            //Inserta el nuevo cambio de estado en el tracker
            //$('#estado').change(function() {
            $("#agregar-estado").click(function(){
                //alert($("#estado").val());
                if($("#estado").val()=='') {
                    alert("Por favor seleccione un estado");
                    $("#estado").focus();
                    return false;
                }else{
                    $.blockUI({message: "<h2>Actualizando estado...</h2>"});
                    $.ajax({
                        url: Routing.generate("tracker_newtracking"),
                        type: 'POST',
                        data: $("#form").serialize(),
                        success: function (data) {
                            $('#table_tracker').DataTable().ajax.reload();
                            $.unblockUI();
                        }
                    });
                    $.unblockUI();
                }
            });

            //Conexión de la tabla de históricos para la guía
            $('#table_tracker').DataTable({
                "dom": 'T<"clear">lfrtip',
                "responsive": true,
                "order": [ 0, 'desc' ],
                "tableTools": {
                    "sSwfPath": "{{ asset('bundles/presisgeneral/css/copy_csv_xls_pdf.swf') }}"
                },
                "ajax": {
                    "url": Routing.generate("tracker_asajax"),
                    "type": 'POST',
                    "data": {
                        "tracking": function ( d ) {
                            return tracking.val();
                        }
                    }
                },
                "language": {
                    "url": "https://cdn.datatables.net/plug-ins/a5734b29083/i18n/Spanish.json"
                },
                "columnDefs": [
                    {
                        "width": "5%", "targets": 13,
                        "data": "id",
                        "render": function ( data, type, full, meta ) {
                            return "<div style='text-align: center'><a href='#' onclick='deleteRow("+data+");return false;'><i class='fa fa-times fa-2x' title='Eliminar cambio de estado'></i></a></div>";
                        }
                    }
                ],
                "columns": [

                    {"data":"id"},
                    {"data":"tracker"},
                    {"data":"estado"},
                    {"data":"nro_planilla"},
                    {"data":"fecha_plani", "defaultContent": "" },
                    {"data":"distribuidor"},
                    {"data":"motivo"},
                    {"data":"receptor_nombre_completo"},
                    {"data":"dni"},
                    {"data":"receptor_fecha_hora"},
                    {"data":"user"},
                    {"data":"timestamp_modificacion"},
                    {"data":"detalles"}

                ]
            });

            function completarDatosDelRetiro() {
                $.blockUI({message: "<h3>Buscando datos...</h3>"});
                $("#remito").val('');
                $('#table_tracker').DataTable().ajax.reload();
                $.ajax({
                    dataType: "json",
                    url: Routing.generate("retiro_asajax"),
                    type: 'GET',
                    data: {
                        "tracking": function (d) {
                            return tracking.val();
                        }
                    },
                    success: function (data) {
                        if (data != null) {
                            $("#reclamos").prop('disabled', false);
                            $.each(data, function (key, val) {
                                $("#" + key).val(val);
                            });
                        } else {
                            $("#reclamos").prop('disabled', true);
                        }
                    },
                    error: function (error) {
                        BootstrapDialog.show({
                            title: 'Error',
                            message: error.responseText
                        });
                        showPopover(tracking, error.responseText);
                        tracking.focus();
                    }
                });
                $.unblockUI();
                $("#presis_trackerbundle_tracker_receptorNombre").focus();
            }

            function elegirRetiro(nombre_atributo, atributo) {
                $.getJSON(
                        Routing.generate("tracker_getretiros_" + nombre_atributo, {
                            id_retiro_atributo: atributo.val()
                        }),
                        function (data) {
                            var $selectRetiro = BootstrapDialog.show({
                                title: 'Elegir retiro',
                                message: '<table id="porRemitos" tabindex="-1" class="table table-hover clickable-row">' +
                                '<thead><tr>' +
                                '<th data-field="id">Id</th>' +
                                '<th data-field="comprador">Comprador</th>' +
                                '<th data-field="comprador_direccion">Dirección</th>' +
                                '<th data-field="comprador_email">Email</th>' +
                                '<th data-field="comprador_localidad">Localidad</th>' +
                                '</tr></thead></table>'
                            });

                            setTimeout(function () {
                                var $table = $('#porRemitos');

                                $table.bootstrapTable({
                                    data: data
                                });
                                $table.siblings(":first").text(""); // TODO Why it says Please wait...?
                                $table.focus();

                                function getSelectedRow() {
                                    var index = $table.find('tr.success').data('index');
                                    return $table.bootstrapTable('getData')[index];
                                }

                                var addRetiroFromTable = function (trackingValue) {
                                    $selectRetiro.close();
                                    tracking.val(trackingValue);
                                    completarDatosDelRetiro();
                                    atributo.val("");
                                };

                                $(function () {
                                    $table.on('click-row.bs.table', function (e, row, $element) {
                                        $('.success').removeClass('success');
                                        $($element).addClass('success');
                                        addRetiroFromTable(getSelectedRow().id);
                                    });
                                });

                                $table.keyup(function (e) {
                                    if (e.keyCode == 13) {
                                        var t = document.getElementById('porRemitos');
                                        addRetiroFromTable($(t.rows[1].cells[0]).text());
                                    }
                                });
                            }, 500);
                        }
                ).fail(function (jqxhr) {
                    showPopover(atributo, jqxhr.responseText);
                });
            }

            //Enter en el número de remito permite elegir entre retiros con el mismo remito
            remito.keyup(function (e) {
                e.preventDefault();
                if (e.keyCode == 13) {
                    elegirRetiro("remito", remito);
                }
            });

            //Enter en la guia agente permite elegir entre retiros con la misma guia agente
            guia_agente.keyup(function (e) {
                e.preventDefault();
                if (e.keyCode == 13) {
                    elegirRetiro("guia_agente", guia_agente);
                }
            });

            //Enter en el número de tracking trae datos de él y el histórico de cambios
            tracking.keyup(function (e) {
                if (e.keyCode == 13) {
                    completarDatosDelRetiro();
                }
            });

            $('.datetimepicker6').datetimepicker({
                locale: moment.locale('es'),
                format: 'YYYY-MM-DD HH:mm'
            });

            /*$("input[name*='receptorFechaHora']").datepicker()
                .on('show', function() {
                    var fechaHora = $(this).val();
                    hora = fechaHora.substring(fechaHora.length - 6, fechaHora.length);
                })
                .on('hide', function() {
                    $(this).val($(this).val()+hora);
            });*/
        });



    </script>
{% endblock %}